# =============================================================================
# Makefile for SSSP Development Environment
# =============================================================================

.PHONY: help start stop restart logs clean rebuild shell status test migrate prune

# Default target
.DEFAULT_GOAL := help

# Docker Compose file location
DOCKER_COMPOSE := docker-compose -f docker/local/docker-compose.yaml

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

# =============================================================================
# Help
# =============================================================================
help: ## Show this help message
	@echo "$(BLUE)SSSP Development Commands$(NC)"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage: make $(GREEN)<target>$(NC)\n\nTargets:\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)

# =============================================================================
# Service Management
# =============================================================================
start: ## Start all development services
	@echo "$(BLUE)Starting development environment...$(NC)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)✓ Services started$(NC)"
	@echo "  API: http://localhost:8080"
	@echo "  AI:  http://localhost:8001"

stop: ## Stop all services
	@echo "$(BLUE)Stopping services...$(NC)"
	@$(DOCKER_COMPOSE) down
	@echo "$(GREEN)✓ Services stopped$(NC)"

restart: stop start ## Restart all services

logs: ## View logs from all services
	@$(DOCKER_COMPOSE) logs -f

logs-api: ## View API service logs
	@$(DOCKER_COMPOSE) logs -f api

logs-ai: ## View AI service logs
	@$(DOCKER_COMPOSE) logs -f ai

status: ## Show service status
	@$(DOCKER_COMPOSE) ps

# =============================================================================
# Build and Rebuild
# =============================================================================
build: ## Build all services
	@echo "$(BLUE)Building services...$(NC)"
	@$(DOCKER_COMPOSE) build

build-api: ## Build API service
	@echo "$(BLUE)Building API service...$(NC)"
	@$(DOCKER_COMPOSE) build api

build-ai: ## Build AI service
	@echo "$(BLUE)Building AI service...$(NC)"
	@$(DOCKER_COMPOSE) build ai

rebuild-api: ## Rebuild API service from scratch
	@echo "$(BLUE)Rebuilding API service...$(NC)"
	@$(DOCKER_COMPOSE) stop api
	@$(DOCKER_COMPOSE) rm -f api
	@$(DOCKER_COMPOSE) build --no-cache api
	@$(DOCKER_COMPOSE) up -d api
	@echo "$(GREEN)✓ API service rebuilt$(NC)"

rebuild-ai: ## Rebuild AI service from scratch
	@echo "$(BLUE)Rebuilding AI service...$(NC)"
	@$(DOCKER_COMPOSE) stop ai
	@$(DOCKER_COMPOSE) rm -f ai
	@$(DOCKER_COMPOSE) build --no-cache ai
	@$(DOCKER_COMPOSE) up -d ai
	@echo "$(GREEN)✓ AI service rebuilt$(NC)"

# =============================================================================
# Cleanup
# =============================================================================
clean: ## Complete cleanup (containers, images, volumes)
	@echo "$(YELLOW)⚠ This will remove all containers, images, and volumes$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "$(BLUE)Cleaning environment...$(NC)"; \
		$(DOCKER_COMPOSE) down -v; \
		docker rmi sssp-api-dev:latest 2>/dev/null || true; \
		docker rmi sssp-ai-dev:latest 2>/dev/null || true; \
		docker volume rm sssp-nuget-packages sssp-nuget-http-cache sssp-ai-data sssp-ai-cache 2>/dev/null || true; \
		find apps/api/src -type d \( -name "obj" -o -name "bin" \) -exec rm -rf {} + 2>/dev/null || true; \
		echo "$(GREEN)✓ Cleanup complete$(NC)"; \
	fi

clean-local: ## Clean local build artifacts only
	@echo "$(BLUE)Cleaning local build artifacts...$(NC)"
	@find apps/api/src -type d \( -name "obj" -o -name "bin" \) -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)✓ Local artifacts cleaned$(NC)"

prune: ## Prune Docker system
	@echo "$(YELLOW)⚠ This will remove all unused Docker resources$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker system prune -af --volumes; \
		echo "$(GREEN)✓ Docker system pruned$(NC)"; \
	fi

# =============================================================================
# Shell Access
# =============================================================================
shell-api: ## Open shell in API container
	@$(DOCKER_COMPOSE) exec api /bin/bash

shell-ai: ## Open shell in AI container
	@$(DOCKER_COMPOSE) exec ai /bin/bash

# =============================================================================
# Testing
# =============================================================================
test: ## Run all tests
	@$(DOCKER_COMPOSE) exec api dotnet test

test-api: ## Run API tests
	@$(DOCKER_COMPOSE) exec api dotnet test

test-ai: ## Run AI tests
	@$(DOCKER_COMPOSE) exec ai pytest

# =============================================================================
# Database
# =============================================================================
migrate: ## Run database migrations
	@echo "$(BLUE)Running database migrations...$(NC)"
	@$(DOCKER_COMPOSE) exec api dotnet ef database update --project /src/src/SSSP.Infrastructure.Persistence
	@echo "$(GREEN)✓ Migrations applied$(NC)"

migration-add: ## Add new migration (use name=YourMigrationName)
	@if [ -z "$(name)" ]; then \
		echo "$(YELLOW)Please specify migration name: make migration-add name=YourMigrationName$(NC)"; \
		exit 1; \
	fi
	@$(DOCKER_COMPOSE) exec api dotnet ef migrations add $(name) --project /src/src/SSSP.Infrastructure.Persistence

# =============================================================================
# Development Helpers
# =============================================================================
install: ## Initial setup (build and start)
	@echo "$(BLUE)Setting up development environment...$(NC)"
	@$(DOCKER_COMPOSE) build
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)✓ Development environment ready$(NC)"

update: ## Pull latest changes and rebuild
	@echo "$(BLUE)Updating services...$(NC)"
	@git pull
	@$(DOCKER_COMPOSE) build
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)✓ Services updated$(NC)"

health: ## Check service health
	@echo "$(BLUE)Checking service health...$(NC)"
	@curl -fsS http://localhost:8080/health && echo "$(GREEN)✓ API is healthy$(NC)" || echo "$(YELLOW)✗ API is not responding$(NC)"
	@curl -fsS http://localhost:8001/api/v1/health/startup && echo "$(GREEN)✓ AI is healthy$(NC)" || echo "$(YELLOW)✗ AI is not responding$(NC)"